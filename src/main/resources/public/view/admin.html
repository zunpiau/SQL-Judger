<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="/lib/sidebar.css" rel="stylesheet">
  <link href="/lib/bootstrap.min.css" rel="stylesheet">
  <script src="/lib/jquery.min.js"></script>
  <script src="/lib/bootstrap.min.js"></script>
  <script src="/lib/vue.js"></script>
  <script src="/lib/axios.js"></script>
  <title>Admin</title>
</head>
<body>
<nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
  <span class="navbar-brand col-sm-3 col-md-2 mr-0">SQL Judger</span>
</nav>
<div class="container-fluid">
  <div class="row" id="vue_main">
    <nav class="col-md-2 d-none d-md-block bg-light sidebar">
      <div class="sidebar-sticky">
        <nav class="nav nav-pills flex-column" id="nav_tabs">
          <a class="nav-link active" data-toggle="pill" href="#home" role="tab">
            Dashboard
          </a>
          <a class="nav-link" data-toggle="pill" href="#teacher" role="tab"
             v-on:click.once="loadTeachers">
            教师管理
          </a>
          <a class="nav-link" data-toggle="pill" href="#clazz" role="tab"
             v-on:click.once="loadClazzs">
            班级管理
          </a>
          <a class="nav-link" data-toggle="pill" href="#teaching" role="tab"
             v-on:click.once="loadTeachings">
            授课管理
          </a>
          <a class="nav-link" data-toggle="pill" href="#student" role="tab"
             v-on:click.once="loadStudents">
            学生管理
          </a>
          <a class="nav-link" data-toggle="pill" href="#contact" role="tab">
            Products
          </a>
        </nav>
      </div>
    </nav>

    <main class="col-md-9 ml-sm-auto col-lg-10 px-4 tab-content" role="main">
      <div class="tab-pane fade show active" id="home" role="tabpanel">
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Dashboard</h1>
        </div>
        <h3 class="h3">Section title</h3>
      </div>
      <div class="tab-pane fade show" id="teacher" role="tabpanel">
        <h1 class="h2">教师管理</h1>
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h3 class="h3">教师列表</h3>
          <div class="mb-2 mb-md-0">
            <button class="btn btn-outline-primary" data-target="#teacherModal" data-toggle="modal">添加</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">教工号</th>
              <th scope="col">姓名</th>
              <th scope="col">操作</th>
            </tr>
            </thead>
            <tbody id="teacher_tbody">
            <tr :key="index" v-for="(teacher, index) in teachers">
              <th scope="row">{{ index + 1 }}</th>
              <td>{{ teacher.number }}</td>
              <td>{{ teacher.name }}</td>
              <td>
                <button class="btn btn-danger btn-sm" v-on:click="deleteTeacher(teacher)">
                  删除
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div class="modal fade" id="teacherModal" role="dialog" tabindex="-1">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">添加教师</h5>
                <button class="close" data-dismiss="modal" type="button">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <input class="form-control mb-2" name="name" placeholder="姓名" v-model="teacher.name">
                  <input class="form-control mb-2" name="password" placeholder="密码" v-model="teacher.password">
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" type="button" v-on:click="addTeacher">添加</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="clazz" role="tabpanel">
        <h1 class="h2">班级管理</h1>
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h3 class="h3">班级列表</h3>
          <div class="mb-2 mb-md-0">
            <button class="btn btn-outline-primary" data-target="#clazzModal" data-toggle="modal">添加
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">年级</th>
              <th scope="col">班级名</th>
              <th scope="col">操作</th>
            </tr>
            </thead>
            <tbody id="clazz_tbody">
            <tr :key="index" v-for="(clazz, index) in clazzs">
              <th scope="row">{{ index + 1 }}</th>
              <td>{{ clazz.grade }}</td>
              <td>{{ clazz.name }}</td>
              <td>
                <button class="btn btn-danger btn-sm" v-on:click="deleteClazz(clazz.id, index)">
                  删除
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div class="modal fade" id="clazzModal" role="dialog" tabindex="-1">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">添加班级</h5>
                <button class="close" data-dismiss="modal" type="button">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <input class="form-control mb-2" id="clazzInputGrade" placeholder="年级"
                         type="number"
                         v-model="clazz.grade">
                  <input class="form-control mb-2" id="clazzInputName" placeholder="班级名"
                         v-model="clazz.name">
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" type="button" v-on:click="addClazz">添加</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="teaching" role="tabpanel">
        <h1 class="h2">授课管理</h1>
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h3 class="h3">授课列表</h3>
          <div class="mb-2 mb-md-0">
            <button class="btn btn-outline-primary" data-target="#teachingModal" data-toggle="modal">添加
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">班级</th>
              <th scope="col">教师</th>
              <th scope="col">操作</th>
            </tr>
            </thead>
            <tbody id="teaching_tbody">
            <tr :key="index" v-for="(teaching, index) in teachings">
              <th scope="row">{{ index + 1 }}</th>
              <td>{{ teaching.clazz.grade }} {{ teaching.clazz.name }}</td>
              <td>{{ teaching.teacher.number }} / {{ teaching.teacher.name }}</td>
              <td>
                <button class="btn btn-danger btn-sm" v-on:click="deleteTeaching(teaching)">
                  删除
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div class="modal fade" id="teachingModal" role="dialog" tabindex="-1">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">添加授课</h5>
                <button class="close" data-dismiss="modal" type="button">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <select class="form-control mb-2" name="teaching.teacher.number" type="number"
                          v-model="teaching.teacher.number">
                    <option v-bind:value="teacher.number" v-for="teacher in teachers">
                      {{ teacher.number }} {{ teacher.name }}
                    </option>
                  </select>
                  <select class="form-control mb-2" name="teaching.clazz.id" v-model="teaching.clazz.id">
                    <option v-bind:value="clazz.id" v-for="clazz in clazzs">
                      {{ clazz.grade }} {{ clazz.name }}
                    </option>
                  </select>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" type="button" v-on:click="addTeaching">添加</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="student" role="tabpanel">
        <h1 class="h2">学生管理</h1>
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h3 class="h3">学生列表</h3>
          <div class="mb-2 mb-md-0">
            <button class="btn btn-outline-primary" data-target="#studentModal" data-toggle="modal">添加
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">学号</th>
              <th scope="col">姓名</th>
              <th scope="col">班级</th>
              <th scope="col">操作</th>
            </tr>
            </thead>
            <tbody id="student_tbody">
            <tr :key="index" v-for="(student, index) in students">
              <th scope="row">{{ index + 1 }}</th>
              <td>{{ student.number }}</td>
              <td>{{ student.name }}</td>
              <td>{{ student.clazz.grade }} {{ student.clazz.name }}</td>
              <td>
                <button class="btn btn-danger btn-sm" v-on:click="deleteStudent(student)">
                  删除
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div class="modal fade" id="studentModal" role="dialog" tabindex="-1">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">添加学生</h5>
                <button class="close" data-dismiss="modal" type="button">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <input class="form-control mb-2" id="studentInputName" placeholder="姓名"
                         v-model="student.name">
                  <input class="form-control mb-2" id="studentInputPassword"
                         placeholder="密码" v-model="student.password">
                  <select class="form-control mb-2" name="student.clazz.id"
                          v-model="student.clazz.id">
                    <option v-bind:value="clazz.id" v-for="clazz in clazzs">
                      {{ clazz.grade }} {{ clazz.name }}
                    </option>
                  </select>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" type="button" v-on:click="addStudent">添加</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="profile" role="tabpanel">...</div>
      <div class="tab-pane fade" id="contact" role="tabpanel">...</div>
    </main>
  </div>
</div>
<script>
    function loadEntity(url, entities) {
        console.log(url);
        axios.get(url)
            .then(response => {
                entities.splice(0, entities.length, ...response.data)
            })
            .catch(reason => {
                console.log(reason);
            })
    }

    function deleteEntity(url, entities, entity) {
        axios.delete(url)
            .then(() => {
                const index = entities.indexOf(entity);
                if (index >= 0)
                    entities.splice(index);
            })
            .catch(reason => {
                console.log(reason);
            });
    }

    function deleteEntityCallback(url, callback) {
        axios.delete(url)
            .then(callback)
            .catch(reason => {
                console.log(reason);
            });
    }

    function addEntity(url, entity, entyties, modal) {
        addEntityCallback(url, entity, response => {
            modal.modal('hide');
            console.log(response.data);
            entyties.push(response.data);
        });
    }

    function addEntityCallback(url, entity, callback) {
        axios.post(url, entity)
            .then(callback)
            .catch(reason => {
                console.log(reason);
            });
    }

    const mainVue = new Vue({
        el: '#vue_main',
        data() {
            return {
                teacher: {},
                teachers: [],
                student: {
                    clazz: {
                        id: 0,
                    }
                },
                students: [],
                clazz: {},
                clazzs: [],
                teaching: {
                    teacher: {
                        number: 0,
                    },
                    clazz: {
                        id: 0,
                    }
                },
                teachings: [],
            }
        },
        methods: {
            loadTeachers() {
                loadEntity('/admin/teacher', this.teachers)
            },
            deleteTeacher(teacher) {
                deleteEntityCallback(`/admin/teacher/${teacher.number}`, (response) => {
                    if (response.data.status === 200) {
                        this.teachers = this.teachers.filter((e) => e !== teacher)
                    } else {
                        alert("无法删除，已被其他对象引用");
                    }
                });
            },
            addTeacher() {
                addEntity('/admin/teacher', this.teacher, this.teachers, $('#teacherModal'));
            },
            loadStudents() {
                loadEntity('/admin/student', this.students);
            },
            deleteStudent(student) {
                deleteEntity(`/admin/student/${student.number}`, this.students, student);
            },
            addStudent() {
                addEntityCallback('/admin/student', this.student, response => {
                    console.log(response.data);
                    if (response.data.status === 200) {
                        $('#studentModal').modal('hide');
                        this.students.push(response.data.data)
                    } else {
                        alert(response.data.msg);
                    }
                });
            },
            loadClazzs() {
                loadEntity('/admin/clazz', this.clazzs);
            },
            deleteClazz(clazz) {
                deleteEntity(`/admin/clazz/${clazz.id}`, this.clazzs, clazz);
            },
            addClazz() {
                addEntity('/admin/clazz', this.clazz, this.clazzs, $('#clazzModal'));
            },
            loadTeachings() {
                loadEntity('/admin/teaching', this.teachings);
            },
            deleteTeaching(teaching) {
                deleteEntity(`/admin/teaching/${teaching.id}`, this.teachings, teaching);
            },
            addTeaching() {
                addEntityCallback('/admin/teaching', this.teaching, response => {
                    if (response.data.status === 200) {
                        $('#teachingModal').modal('hide');
                        this.teachings.push(response.data.data);
                    } else {
                        alert(response.data.msg);
                    }
                });
            }
        }
    });

    $('#teachingModal').on('show.bs.modal', loadIfNeeded);
    $('#studentModal').on('show.bs.modal', loadIfNeeded);

    function loadIfNeeded() {
        if (mainVue.teachers.length === 0) {
            mainVue.loadTeachers();
        }
        if (mainVue.clazzs.length === 0) {
            mainVue.loadClazzs();
        }
    }
</script>
</body>
</html>